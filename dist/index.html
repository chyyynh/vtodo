<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VTodo - Kanban Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles */
    .dragging {
      opacity: 0.5;
    }

    .drag-over {
      border: 2px dashed #3b82f6;
      background-color: #dbeafe;
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .todo-card {
      transition: all 0.2s ease;
    }

    .todo-card:hover {
      transform: translateY(-2px);
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-bar {
      transition: width 0.3s ease;
    }

    .checklist-item {
      transition: all 0.2s ease;
    }

    .checklist-item:hover {
      background-color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- App Container -->
  <div id="app" class="container mx-auto p-4 max-w-7xl">
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-800">VTodo Kanban Board</h1>
        <button
          id="add-todo-btn"
          class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition flex items-center gap-2"
        >
          <span>+ Add Todo</span>
        </button>
      </div>
    </header>

    <!-- Loading State -->
    <div id="loading" class="hidden flex justify-center items-center py-20">
      <div class="spinner"></div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p class="font-bold">Error</p>
      <p id="error-message"></p>
    </div>

    <!-- Kanban Board -->
    <div id="board" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Columns will be rendered here -->
    </div>
  </div>

  <!-- Edit/Create Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto fade-in">
      <!-- Modal content will be rendered here -->
    </div>
  </div>

  <script>
    // ============================================
    // State Management
    // ============================================
    const state = {
      todos: [],
      loading: false,
      error: null
    };

    const listeners = [];

    function setState(updates) {
      Object.assign(state, updates);
      listeners.forEach(fn => fn(state));
    }

    function subscribe(listener) {
      listeners.push(listener);
      return () => {
        const index = listeners.indexOf(listener);
        if (index > -1) listeners.splice(index, 1);
      };
    }

    // ============================================
    // API Client
    // ============================================
    const API = {
      async fetchTodos() {
        const response = await fetch('/api/todos');
        const data = await response.json();
        return data.todos || [];
      },

      async fetchTodoDetail(id) {
        const response = await fetch(`/api/todos/${id}`);
        const data = await response.json();
        return data.todo;
      },

      async createTodo(todoData) {
        const response = await fetch('/api/todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(todoData)
        });
        const data = await response.json();
        return data.todo;
      },

      async updateTodo(id, updates) {
        const response = await fetch(`/api/todos/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        const data = await response.json();
        return data.todo;
      },

      async deleteTodo(id) {
        await fetch(`/api/todos/${id}`, { method: 'DELETE' });
      },

      async updateDetail(id, content) {
        await fetch(`/api/todos/${id}/detail`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });
      }
    };

    // ============================================
    // Utilities
    // ============================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function getStatusLabel(status) {
      const labels = {
        'pending': 'Pending',
        'in-progress': 'In Progress',
        'completed': 'Completed'
      };
      return labels[status] || status;
    }

    function getStatusColor(status) {
      const colors = {
        'pending': 'bg-gray-200 text-gray-700',
        'in-progress': 'bg-yellow-200 text-yellow-800',
        'completed': 'bg-green-200 text-green-800'
      };
      return colors[status] || 'bg-gray-200';
    }

    // ============================================
    // Rendering Functions
    // ============================================
    function renderColumn(status, todos) {
      const column = document.createElement('div');
      column.className = 'bg-white rounded-lg p-4 shadow-md min-h-[400px]';
      column.dataset.status = status;

      // Drop zone setup
      column.addEventListener('dragover', handleDragOver);
      column.addEventListener('drop', handleDrop);
      column.addEventListener('dragleave', handleDragLeave);

      // Header
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between mb-4';

      const title = document.createElement('h2');
      title.className = 'font-bold text-lg text-gray-700';
      title.textContent = getStatusLabel(status);

      const count = document.createElement('span');
      const filteredTodos = todos.filter(t => t.status === status);
      count.className = 'bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-sm font-semibold';
      count.textContent = filteredTodos.length;

      header.appendChild(title);
      header.appendChild(count);
      column.appendChild(header);

      // Todo cards
      filteredTodos.forEach(todo => {
        column.appendChild(renderTodoCard(todo));
      });

      return column;
    }

    function renderTodoCard(todo) {
      const card = document.createElement('div');
      card.className = 'todo-card bg-gray-50 p-4 rounded-lg mb-3 cursor-move hover:shadow-lg border border-gray-200';
      card.draggable = true;
      card.dataset.todoId = todo.id;

      // Drag events
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
      card.addEventListener('click', () => openEditModal(todo.id));

      // Card content
      const titleDiv = document.createElement('div');
      titleDiv.className = 'font-semibold text-gray-800 mb-2';
      titleDiv.textContent = todo.title;
      card.appendChild(titleDiv);

      // Description preview
      if (todo.description) {
        const descDiv = document.createElement('div');
        descDiv.className = 'text-sm text-gray-600 mb-2 line-clamp-2';
        descDiv.textContent = todo.description;
        card.appendChild(descDiv);
      }

      // Progress bar if has checklist
      if (todo.checklist && todo.checklist.length > 0) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'mb-2';

        const progressText = document.createElement('div');
        progressText.className = 'text-xs text-gray-500 mb-1';
        progressText.textContent = `Progress: ${todo.progress.completed}/${todo.progress.total}`;

        const progressBarBg = document.createElement('div');
        progressBarBg.className = 'w-full bg-gray-200 rounded-full h-2';

        const progressBarFill = document.createElement('div');
        progressBarFill.className = 'progress-bar bg-blue-500 h-2 rounded-full';
        progressBarFill.style.width = `${todo.progress.percentage}%`;

        progressBarBg.appendChild(progressBarFill);
        progressContainer.appendChild(progressText);
        progressContainer.appendChild(progressBarBg);
        card.appendChild(progressContainer);
      }

      // Tags
      if (todo.tags && todo.tags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'flex flex-wrap gap-1 mt-2';
        todo.tags.forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs';
          tagSpan.textContent = tag;
          tagsDiv.appendChild(tagSpan);
        });
        card.appendChild(tagsDiv);
      }

      return card;
    }

    function render() {
      const board = document.getElementById('board');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      if (state.loading) {
        board.classList.add('hidden');
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        return;
      }

      loadingEl.classList.add('hidden');

      if (state.error) {
        errorEl.classList.remove('hidden');
        document.getElementById('error-message').textContent = state.error;
        board.classList.add('hidden');
        return;
      }

      errorEl.classList.add('hidden');
      board.classList.remove('hidden');
      board.innerHTML = '';

      const statuses = ['pending', 'in-progress', 'completed'];
      statuses.forEach(status => {
        board.appendChild(renderColumn(status, state.todos));
      });
    }

    // ============================================
    // Drag & Drop
    // ============================================
    let draggedElement = null;

    function handleDragStart(e) {
      draggedElement = e.currentTarget;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);
    }

    function handleDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      // Remove drag-over from all columns
      document.querySelectorAll('[data-status]').forEach(col => {
        col.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
      return false;
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      if (e.stopPropagation) e.stopPropagation();
      e.preventDefault();

      const column = e.currentTarget;
      column.classList.remove('drag-over');

      if (draggedElement) {
        const todoId = draggedElement.dataset.todoId;
        const newStatus = column.dataset.status;
        const currentTodo = state.todos.find(t => t.id === todoId);

        if (currentTodo && currentTodo.status !== newStatus) {
          try {
            await API.updateTodo(todoId, { status: newStatus });
            await loadTodos();
          } catch (error) {
            console.error('Error updating todo:', error);
            setState({ error: 'Failed to update todo status' });
          }
        }
      }

      return false;
    }

    // ============================================
    // Modal Management
    // ============================================
    async function openEditModal(todoId = null) {
      const modal = document.getElementById('modal');
      const modalContent = modal.querySelector('div');

      let todo = null;
      if (todoId) {
        try {
          todo = await API.fetchTodoDetail(todoId);
        } catch (error) {
          console.error('Error fetching todo:', error);
          setState({ error: 'Failed to load todo details' });
          return;
        }
      }

      const isNew = !todo;
      const title = isNew ? 'Create New Todo' : 'Edit Todo';

      modalContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">${title}</h2>
        <form id="todo-form">
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Title *</label>
            <input
              type="text"
              name="title"
              value="${escapeHtml(todo?.title || '')}"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter todo title"
            >
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Description</label>
            <textarea
              name="description"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Enter description"
            >${escapeHtml(todo?.description || '')}</textarea>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Expected Outcome</label>
            <textarea
              name="expected"
              rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="What should be achieved?"
            >${escapeHtml(todo?.expected || '')}</textarea>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Tags (comma separated)</label>
            <input
              type="text"
              name="tags"
              value="${(todo?.tags || []).join(', ')}"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="e.g., frontend, bug, urgent"
            >
          </div>

          ${!isNew ? `
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2 text-gray-700">Status</label>
            <select
              name="status"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="pending" ${todo.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="in-progress" ${todo.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="completed" ${todo.status === 'completed' ? 'selected' : ''}>Completed</option>
            </select>
          </div>
          ` : ''}

          <div class="mb-6">
            <label class="block text-sm font-medium mb-2 text-gray-700">Checklist</label>
            <div id="checklist-container" class="space-y-2 mb-2">
              ${renderChecklistItems(todo?.checklist || [])}
            </div>
            <button
              type="button"
              id="add-checklist-item"
              class="text-sm text-blue-500 hover:text-blue-700"
            >
              + Add checklist item
            </button>
          </div>

          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="cancel-btn"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
            >
              ${isNew ? 'Create' : 'Save'}
            </button>
            ${!isNew ? `
            <button
              type="button"
              id="delete-btn"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
            >
              Delete
            </button>
            ` : ''}
          </div>
        </form>
      `;

      modal.classList.remove('hidden');

      // Event listeners
      document.getElementById('cancel-btn').addEventListener('click', closeModal);

      if (!isNew) {
        document.getElementById('delete-btn').addEventListener('click', () => deleteTodoHandler(todoId));
      }

      document.getElementById('add-checklist-item').addEventListener('click', addChecklistItem);

      document.getElementById('todo-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveTodo(todoId);
      });

      // Setup checklist item listeners
      setupChecklistListeners();
    }

    function renderChecklistItems(checklist) {
      if (!checklist || checklist.length === 0) {
        return '<p class="text-sm text-gray-500">No checklist items yet</p>';
      }

      return checklist.map((item, index) => `
        <div class="checklist-item flex items-center gap-2 p-2 border border-gray-200 rounded" data-index="${index}">
          <input
            type="checkbox"
            class="checklist-checkbox"
            ${item.done ? 'checked' : ''}
          >
          <input
            type="text"
            class="checklist-text flex-1 px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 rounded"
            value="${escapeHtml(item.text)}"
          >
          <button type="button" class="remove-checklist text-red-500 hover:text-red-700 text-sm">Remove</button>
        </div>
      `).join('');
    }

    function setupChecklistListeners() {
      document.querySelectorAll('.remove-checklist').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.checklist-item').remove();
        });
      });
    }

    function addChecklistItem() {
      const container = document.getElementById('checklist-container');
      const existingMessage = container.querySelector('p');
      if (existingMessage) {
        existingMessage.remove();
      }

      const itemDiv = document.createElement('div');
      itemDiv.className = 'checklist-item flex items-center gap-2 p-2 border border-gray-200 rounded';
      itemDiv.innerHTML = `
        <input type="checkbox" class="checklist-checkbox">
        <input
          type="text"
          class="checklist-text flex-1 px-2 py-1 border-0 focus:ring-1 focus:ring-blue-500 rounded"
          placeholder="New checklist item"
        >
        <button type="button" class="remove-checklist text-red-500 hover:text-red-700 text-sm">Remove</button>
      `;

      container.appendChild(itemDiv);

      itemDiv.querySelector('.remove-checklist').addEventListener('click', () => {
        itemDiv.remove();
      });

      itemDiv.querySelector('.checklist-text').focus();
    }

    function getChecklistFromForm() {
      const items = [];
      document.querySelectorAll('.checklist-item').forEach(item => {
        const text = item.querySelector('.checklist-text').value.trim();
        if (text) {
          items.push({
            text,
            done: item.querySelector('.checklist-checkbox').checked
          });
        }
      });
      return items;
    }

    async function saveTodo(todoId) {
      const form = document.getElementById('todo-form');
      const formData = new FormData(form);

      const todoData = {
        title: formData.get('title'),
        description: formData.get('description'),
        expected: formData.get('expected'),
        tags: formData.get('tags').split(',').map(t => t.trim()).filter(Boolean),
        checklist: getChecklistFromForm()
      };

      if (!todoId) {
        // Creating new todo
        todoData.status = 'pending';
      } else {
        // Updating existing todo
        todoData.status = formData.get('status');
      }

      try {
        if (todoId) {
          await API.updateTodo(todoId, todoData);
        } else {
          await API.createTodo(todoData);
        }
        await loadTodos();
        closeModal();
      } catch (error) {
        console.error('Error saving todo:', error);
        setState({ error: 'Failed to save todo' });
      }
    }

    async function deleteTodoHandler(id) {
      if (confirm('Are you sure you want to delete this todo?')) {
        try {
          await API.deleteTodo(id);
          await loadTodos();
          closeModal();
        } catch (error) {
          console.error('Error deleting todo:', error);
          setState({ error: 'Failed to delete todo' });
        }
      }
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }

    // ============================================
    // App Initialization
    // ============================================
    async function loadTodos() {
      setState({ loading: true, error: null });
      try {
        const todos = await API.fetchTodos();
        setState({ todos, loading: false });
      } catch (error) {
        console.error('Error loading todos:', error);
        setState({ error: error.message, loading: false });
      }
    }

    // Subscribe to state changes
    subscribe(render);

    // Initialize app
    loadTodos();

    // Event listeners
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target.id === 'modal') closeModal();
    });

    document.getElementById('add-todo-btn').addEventListener('click', () => {
      openEditModal(null);
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // ESC to close modal
      if (e.key === 'Escape') {
        closeModal();
      }
      // Ctrl/Cmd + N to add new todo
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openEditModal(null);
      }
    });
  </script>
</body>
</html>
